<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starting Service...</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; align-items: center; justify-content: center;
            min-height: 100vh; color: white;
        }
        .container {
            text-align: center; padding: 2rem;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px; max-width: 500px;
        }
        h1 { font-size: 2.5rem; margin-bottom: 1rem; }
        .spinner {
            margin: 2rem auto; width: 60px; height: 60px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status { margin: 1rem 0; font-size: 1.2rem; }
        #countdown { font-size: 2rem; margin: 1rem 0; }
        .details { font-size: 0.9rem; opacity: 0.7; margin-top: 1rem; }
        #debug { 
            margin-top: 2rem; padding: 1rem;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            font-size: 0.8rem;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="title">ðŸš€ Starting Service</h1>
        <div class="spinner"></div>
        <div class="status" id="status">Activating service...</div>
        <div id="countdown">60</div>
        <div class="details">
            The page will reload automatically when ready
        </div>
        <div id="debug"></div>
    </div>
    <script>
        // Get current hostname and determine service
        const host = window.location.hostname;
        const protocol = window.location.protocol;
        
        // Map hostnames to services
        const serviceMap = {
            'recipes.local': { name: 'mealie', displayName: 'Mealie', time: 60 },
            'minio.local': { name: 'minio', displayName: 'MinIO', time: 45 },
            'git.local': { name: 'forgejo', displayName: 'Forgejo', time: 60 },
            'vault.local': { name: 'vaultwarden', displayName: 'Vaultwarden', time: 60 }
        };
        
        const service = serviceMap[host];
        let countdown = service ? service.time : 60;
        let checkAttempts = 0;
        const maxCheckAttempts = 40; // 40 attempts * 3 seconds = 2 minutes
        
        // Debug logging
        function log(message) {
            console.log(message);
            const debugDiv = document.getElementById('debug');
            const time = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `[${time}] ${message}<br>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }
        
        // Update UI for detected service
        if (service) {
            document.getElementById('title').textContent = `ðŸš€ Starting ${service.displayName}`;
            document.getElementById('status').textContent = `Activating ${service.displayName}...`;
            log(`Detected service: ${service.displayName} (${service.name})`);
        } else {
            log(`Unknown host: ${host}`);
        }
        
        // Try to start service via webhook
        function startService() {
            if (!service) {
                log('ERROR: No service mapping for this host');
                return;
            }
            
            // Try all three manager nodes
            const managerNodes = [
                '192.168.99.101',
                '192.168.99.102',
                '192.168.99.103'
            ];
            
            log(`Sending webhook requests to start ${service.name}...`);
            
            managerNodes.forEach(function(nodeIp) {
                const webhookUrl = `http://${nodeIp}:9999/start/${service.name}`;
                
                log(`Trying: ${webhookUrl}`);
                
                // Use fetch with no-cors mode (we don't need the response)
                fetch(webhookUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(function() {
                    log(`âœ“ Request sent to ${nodeIp}`);
                }).catch(function(error) {
                    log(`âœ— Failed to ${nodeIp}: ${error.message}`);
                });
            });
            
            log('Webhook requests sent to all manager nodes');
        }
        
        // Check if service is ready by trying to fetch the actual service
        function checkServiceReady() {
            checkAttempts++;
            
            if (checkAttempts > maxCheckAttempts) {
                log('ERROR: Service did not start after 2 minutes');
                document.getElementById('status').textContent = 'Service failed to start. Please try again.';
                return;
            }
            
            log(`Check attempt ${checkAttempts}/${maxCheckAttempts}`);
            
            // Try to fetch from the actual service
            // When service is up, this request will succeed (or get a real response)
            // When service is down, Traefik routes to this catchall
            fetch(window.location.href, {
                method: 'HEAD',
                cache: 'no-cache',
                redirect: 'manual'
            })
            .then(function(response) {
                log(`HEAD response: ${response.status} ${response.statusText}`);
                
                // Check if we're still getting the splash page
                const contentType = response.headers.get('content-type') || '';
                
                // If we get HTML, we might still be on the splash page
                // If we get something else, the service is probably up
                if (response.status === 200 && !contentType.includes('text/html')) {
                    log('âœ“ Service appears to be ready (non-HTML response)');
                    document.getElementById('status').textContent = 'Service ready! Reloading...';
                    setTimeout(function() {
                        window.location.reload();
                    }, 1000);
                    return true;
                }
                
                // Check if we're being redirected (service is up)
                if (response.type === 'opaqueredirect' || response.redirected) {
                    log('âœ“ Service is redirecting (likely ready)');
                    document.getElementById('status').textContent = 'Service ready! Reloading...';
                    setTimeout(function() {
                        window.location.reload();
                    }, 1000);
                    return true;
                }
                
                return false;
            })
            .catch(function(error) {
                log(`Check failed: ${error.message}`);
                return false;
            });
        }
        
        // Countdown timer
        const countdownEl = document.getElementById('countdown');
        const timer = setInterval(function() {
            countdown--;
            countdownEl.textContent = countdown;
            if (countdown <= 0) {
                clearInterval(timer);
                log('Countdown finished');
            }
        }, 1000);
        
        // Start the service immediately
        startService();
        
        // Start checking if service is ready
        log('Starting service readiness checks...');
        const checker = setInterval(function() {
            checkServiceReady();
        }, 3000); // Check every 3 seconds
        
        // Force reload after max time
        setTimeout(function() {
            log('Max wait time reached, forcing reload');
            clearInterval(checker);
            clearInterval(timer);
            window.location.reload();
        }, service ? (service.time * 1000) : 60000);
        
        log('Splash page loaded and initialized');
    </script>
</body>
</html>
