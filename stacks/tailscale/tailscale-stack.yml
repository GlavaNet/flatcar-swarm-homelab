version: '3.8'

services:
  router:
    image: tailscale/tailscale:latest
    hostname: "{{.Node.Hostname}}"
    secrets:
      - tailscale_auth_key
    volumes:
      - tailscale-state:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
      - TS_ROUTES=192.168.99.0/24
      - TS_EXTRA_ARGS=--advertise-exit-node --reset
      - TS_ACCEPT_DNS=true
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        export TS_AUTHKEY=$$(cat /run/secrets/tailscale_auth_key)
        exec /usr/local/bin/containerboot
    networks:
      - tailscale
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

secrets:
  tailscale_auth_key:
    external: true

volumes:
  tailscale-state:

networks:
  tailscale:
    driver: overlay
